---
title: "The AB/BA cross-over"
editor: source
---

```{r}
#| label: 02-setup
#| message: false
#| warning: false

library(broom)
library(gt)
library(lme4)
library(tidyverse)
```


```{r}
#| label: 02-read

asthma_1 <- read_table(
  file="../data/asthma_1.txt",
  col_names=TRUE,
  col_types="ncnn")

asthma_2 <- read_table(
  file="../data/asthma_2.txt",
  col_names=TRUE,
  col_types="ncnn")

asthma_2 |>
  pivot_longer(
    cols=c(formoterol, salbutamol),
    names_to="treatment",
    values_to="pef") |>
  mutate(id=factor(id)) -> asthma_3
```

## Data layout

![](../images/asthma_1.png)

## Alternate data layout

![](../images/asthma_2.png)

## Descriptive statistics, period 1

```{r}
#| label: 02-period-1

asthma_1 |>
  calculate_descriptives("period1")
```

## Descriptive statistics, period 2

```{r}
#| label: 02-period-2

asthma_1 |>
  summarize(
    mean_period_2=mean(period2, na.rm=TRUE),
    sd_period_2=sd(period2, na.rm=TRUE),
    n=sum(!is.na(period2))) |>
  gt() |>
  fmt_number(
    columns=1:2,
    decimals=1)
```

## Descriptive statistics, period gap

```{r}
#| label: 02-period-gap

asthma_1 |>
  mutate(period_gap=period2-period1) |>
  summarize(
    mean_period_gap=mean(period_gap, na.rm=TRUE),
    sd_period_gap=sd(period_gap, na.rm=TRUE),
    n=sum(!is.na(period_gap))) |>
  gt() |>
  fmt_number(
    columns=1:2,
    decimals=1)
```

## Descriptive statistics, formoterol

```{r}
#| label: 02-formoterol

asthma_2 |>
  summarize(
    mean_formoterol=mean(formoterol, na.rm=TRUE),
    sd_formoterol=sd(formoterol, na.rm=TRUE),
    n=sum(!is.na(formoterol))) |>
  gt() |>
  fmt_number(
    columns=1:2,
    decimals=1)
```

## Descriptive statistics, salbutamol

```{r}
#| label: 02-salbutamol

asthma_2 |>
  summarize(
    mean_salbutamol=mean(salbutamol, na.rm=TRUE),
    sd_salbutamol=sd(salbutamol, na.rm=TRUE),
    n=sum(!is.na(salbutamol))) |>
  gt() |>
  fmt_number(
    columns=1:2,
    decimals=1)
```

## Descriptive statistics, drug gap

```{r}
#| label: 02-drug-gap

asthma_2 |>
  mutate(drug_gap=formoterol-salbutamol) |>
  summarize(
    mean_drug_gap=mean(drug_gap, na.rm=TRUE),
    sd_drug_gap=sd(drug_gap, na.rm=TRUE),
    n=sum(!is.na(drug_gap))) |>
  gt() |>
  fmt_number(
    columns=1:2,
    decimals=1)
```

## Paired t-test

```{r}
#| label: 02-paired

t.test(
  asthma_2$formoterol, 
  asthma_2$salbutamol,
  paired=TRUE)
```

## Recalculate paired t-test with different package

## Analysis using a completely randomized block design

```{r}
#| label: 02-alternate-1

m4 <- lm(pef ~ treatment + factor(id), data=asthma_3)
anova(m4)
```

## Alternate form with different package
