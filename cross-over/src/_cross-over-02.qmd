---
title: "The AB/BA cross-over"
editor: source
---

```{r}
#| label: 02-setup
#| message: false
#| warning: false

library(broom)
library(gt)
library(lme4)
library(tidyverse)
```


```{r}
#| label: 02-read

asthma_1 <- read_table(
  file="../data/asthma_1.txt",
  col_names=TRUE,
  col_types="ncnn")

asthma_2 <- read_table(
  file="../data/asthma_2.txt",
  col_names=TRUE,
  col_types="ncnn")

asthma_2 |>
  pivot_longer(
    cols=c(formoterol, salbutamol),
    names_to="treatment",
    values_to="pef") |>
  mutate(id=factor(id)) |>
  mutate(period=case_when(
    treatment=="formoterol" & order=="for/sal" ~ 1,
    treatment=="formoterol" & order=="sal/for" ~ 2,
    treatment=="salbutamol" & order=="for/sal" ~ 2,
    treatment=="salbutamol" & order=="sal/for" ~ 1)) |>
  relocate(pef, .after=period) |>
  relocate(order, .after=treatment) -> asthma_3

write_tsv(asthma_3, "../data/asthma_3.txt")
```

## Data layout

![](../images/asthma_1.png)

## Alternate data layout

![](../images/asthma_2.png)

## Descriptive statistics, period 1

```{r}
#| label: 02-period-1

asthma_1 |>
  calculate_descriptives("period1")
```

## Descriptive statistics, period 2

```{r}
#| label: 02-period-2

asthma_1 |>
  calculate_descriptives("period2")
```

## Descriptive statistics, period gap

```{r}
#| label: 02-period-gap

asthma_1 |>
  mutate(period_gap=period2-period1) |>
  calculate_descriptives("period_gap")
```

## Descriptive statistics, formoterol

```{r}
#| label: 02-formoterol

asthma_2 |>
  calculate_descriptives("formoterol")
```

## Descriptive statistics, salbutamol

```{r}
#| label: 02-salbutamol

asthma_2 |>
  calculate_descriptives("salbutamol")
```

## Descriptive statistics, drug gap

```{r}
#| label: 02-drug-gap

asthma_2 |>
  mutate(drug_gap=formoterol-salbutamol) |>
  calculate_descriptives("drug_gap")
```

## Paired t-test

```{r}
#| label: 02-paired

t.test(
  asthma_2$formoterol, 
  asthma_2$salbutamol,
  paired=TRUE)
```

## Recalculate paired t-test with different package

## Analysis using a completely randomized block design

```{r}
#| label: 02-alternate-1

m4 <- lm(pef ~ treatment + factor(id), data=asthma_3)
anova(m4)
```

## Alternate form with different package
