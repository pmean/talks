---
title: "The paired t-test"
editor: source
---

```{r}
#| label: 01-setup
#| message: false
#| warning: false

library(broom)
library(gt)
library(lme4)
library(tidyverse)
```


## Quotations from two great philosophers

-   "A man cannot step into the same river twice, because it is not the same river, and he is not same man." - Heraclitus, 544 B.C.
-   "You must unlearn what you have learned." Yoda, 1980 A.D.

::: notes
Speaker notes.

I want to start with quotes from two great philosophers. You know they are great philosophers because they are known by a single name.

Heraclitus in 544 B.C. said "A man cannot step into the same river twice, because it is not the same river, and he is not same man."

Yoda, the other great philosopher, said in 1980 A.D. "You must unlearn what you have learned."
:::
    
## Paired t-test data

![](../images/couples.png)

::: notes
Speaker notes

Before talking about cross-over trials, you might find it helpful to review how the paired t-test works. Here is some data I found on the web with measurements on married couples. The data has the wife's age (wAge) and the husband's age (hAge). Do you think there is a tendency for older men to marry younger women?

There is also data on the wife's height (wHeight) and the husbands height (hHeight). We won't analyze this but there is probably something interesting about tall and short patterns.
:::

```{r}
#| label: 01-read

couples <- read_tsv(
  file="../data/couples.txt",
  na=c("*",""),
  col_names=TRUE,
  col_types="cnnnn")
```

## Descriptive statistics on wife's age

```{r}
#| label: 01-age-wife

calculate_descriptives <- 
  function(d, v, f_text="", t_pct=30) {
  d |>
    summarize(
      mean=mean(.data[[v]], na.rm=TRUE),
      sd=sd(.data[[v]], na.rm=TRUE),
      n=sum(!is.na(.data[[v]]))) |>
    mutate(variable = v) |>
    relocate(variable) |>
    gt() |>
    fmt_number(
      columns=2:3,
      decimals=1) |>
    tab_options(table.width=pct(t_pct)) -> d_table
  if (nchar(f_text) == 0) return(d_table)
  d_table |>
    tab_footnote(
      footnote = f_text,
      locations = cells_column_labels(columns = mean))
}

couples |>
  calculate_descriptives("wAge")
```

::: notes
Speaker notes

The average woman is around 41 years old with a standard deviation a bit more than 11.
:::

## Descriptive statistics on husband's age

```{r}
#| label: 01-age-husband

couples |>
  calculate_descriptives("hAge")
```

::: notes
Speaker notes

The average husband is around 43 years old, just slightly older than the average wife. The standard deviation is about the same.
:::

## Descriptive statistics on age gap

```{r}
#| label: 01-age-gap

couples |>
  mutate(age_gap=hAge-wAge) -> couples
couples |>
  calculate_descriptives("age_gap")
```

::: notes
Speaker notes

The average age gap is about 2 years. This average is not quite the same as the difference between the two averages, because there are some married couples with one age but not the other. These are not included in the computation of the age gap, leading to a slight discrepancy.
:::

## Paired t-test on couples ages

```{r}
#| label: 01-paired

pv <- function(test_list) {
  test_list$p.value |>
    signif(digits=2) -> p
  ifelse(p < 0.001, "p<0.001", paste0("p=", p))
}

m1 <- t.test(couples$hAge, couples$wAge, paired=TRUE)

d_mean <- mean(couples$age_gap, na.rm=TRUE)
d_stdev <- sd(couples$age_gap, na.rm=TRUE)
d_stderr <- d_stdev /sqrt(sum(!is.na(couples$age_gap)))

d_mean <- round(d_mean, 1)
d_stdev <- round(d_stdev, 1)
d_stderr <- round(d_stderr, 1)
t_value <- round(m1$statistic, 2)
p_value <- pv(m1)
```

-   Difference mean ($\bar{D}$) = `r d_mean`
-   Difference standard deviation ($S_D$) = `r d_stdev`
-   Difference standard error ($S_D / \sqrt{n}$) = `r d_stderr`
-   Test statistic $\Big(\frac{\bar{D}}{S_D/\sqrt{n}}\Big)$ = `r t_value`
-   `r pv(m1)`

::: notes
Speaker notes

The paired t-test shows a statistically significant difference. The 95% confidence interval tells you that even after allowing for sampling error, the average husband's age is 1.6 years larger than the average wife's age.
:::

## Analyze as completely randomized block design

```{r}
#| label: pivot_ages

couples |>
  mutate(pair=sprintf("c%03d", 1:nrow(couples))) |>
  filter(!is.na(wAge)) |>
  filter(!is.na(hAge)) |>
  select(pair, wAge, hAge) |>
  pivot_longer(
    cols=c(wAge, hAge),
    names_to="spouse",
    values_to="age") |>
  mutate(spouse=str_sub(spouse, 1, 1)) -> couples_1

write_tsv(couples_1, file="../data/couples_1.txt")

m2 <- lm(age ~ spouse + pair, data=couples_1) 
anova(m2)
```

::: notes
Speaker notes

You could also analyze this as a completely randomized block design. It takes a bit of restructuring because this design expects to see all the ages in a single column.

No one does a paired t-test this way, but if you wanted to handle more complex settings, such as risk adjustments on a paired t-test, you can do this fairly easily using a mixed model.
:::

## Restructured data for a completely randomized block design

![](../images/couples_1.png)

::: notes
Speaker notes

Here is what the data must look like if you want to analyze it using a completely randomized block design.
:::

## Mixed model/random coefficient analysis

-   Uses long format
-   Dependent variable: age
-   Fixed effect: spouse
-   Random intercept: pair

::: notes
Speaker notes

You could also analyze the paired t-test using a mixed models or random coefficients approach. It would use the same long format that you use for the completely randomized block design. Specify age as the dependent variable, spouse as a fixed effect and specify a random intercept for each value of pair.

This may seem like killing a fly with cannon. True enough, but when you start looking at more complex settings, you may find this approach to be useful.

I'm not going to show any analyses using mixed models in this talk, but wanted to mention this in case you run into something later where this can help.
:::
